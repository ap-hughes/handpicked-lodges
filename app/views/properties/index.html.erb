<% content_for :meta_title, "Handpicked Lodges in and around Aviemore" %>
<% content_for :meta_description, "Great pet friendly lodges in the North with woodburners and sauna/hottub in Aviemore and the Cairngorms, sleeping 2,4,6 & 8" %>
<script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
<div class="container">
  <div class="row">
    <h1 class="text-center">Cosy Cottages and Rural Retreats</h1>
    <div class="col-xs-12 col-md-6">
      <h3>What makes a Handpicked Lodge?</h3>
      <p>Our lodges are all unique and characterful, but also wonderfully comfortable and welcoming. We want these handpicked holiday homes to truly be your home from home so we've made sure that they are fully kitted out with everything you may need during your stay. They are all perfect for families and for dogs and are in convenient but peaceful locations. They are all close to shops for everyday needs - but the Handpicked Lodges team are also at the end of the phone and only 15 minutes away should you ever need any further help or advice.</p>
    </div>
    <div class="col-xs-12 col-md-6">
      <h3>What is included in our Lodges?</h3>
      <p>â€‹They all include kitchen linen and washing up materials, hand wash, towels and hairdryers, dishwashers and washing machines. There are no extra charges for heating and lighting and most provide free logs for the wood burning stoves during the winter months. Cots and high chairs are available on request. Many offer short breaks (2 nights or more) and they all offer weekend breaks as well as week long holidays.</p>
      <p style="font-size: 14px">Please note: all our lodges are no smoking</p>
    </div>
  </div>
</div>
<div class="container">
  <div class="main-container">
    <div class="row">
      <div class="col-xs-12 col-lg-4 tall" id="properties-sidebar">
        <div class="properties-sidebar-content">
          <!-- <a onclick="on()"> -->
            <div class="map-button">
              <div class="map-button-text">
                <p>View Map <%= fa_icon "map-marker" %></p>
              </div>
            </div>
<!--           </a> -->
          <h4>Check availability for your handpicked lodge</h4>
          <div class="availability-checker">
            <%= simple_form_for :search, url: properties_path, method: :get do |t| %>
              <%= t.input :start_date, placeholder: "Check-in", label: false, as: :string, input_html: { class: "start-date-picker", require: true } %>
              <%= t.input :end_date, placeholder: "Check-out", label: false, as: :string, input_html: { class: "end-date-picker" } %>
              <%= t.submit "CHECK AVAILABILITY", name: nil, class: "btn btn-success", :input_html => { id: 'products_search' } %>
            <% end %>
          </div>
<!--           <%= simple_form_for :query, url: properties_path, method: :get, :defaults => { :input_html => { :class => "form-spacing" } } do |f| %>
            <%= f.input :wood_stove, as: :boolean, checked_value: true, unchecked_value: false %>
            <%= f.input :hot_tub, as: :boolean, checked_value: true, unchecked_value: false %>
            <%= f.input :pet_friendly, as: :boolean, checked_value: true, unchecked_value: false %>
            <%= f.input :sauna, as: :boolean, checked_value: true, unchecked_value: false %>
            <%= f.button :submit, "FILTER RESULTS", name: nil, class: "btn btn-success" %>
          <% end %> -->
        </div>
      </div>
      <% if mobile_device? %>
        <%= render 'mobile_index' %>
      <% else %>
        <%= render 'desktop_index' %>
      <% end %>
    </div>
  </div>
</div>
<% a = (1..@properties.count).to_a %>
<script>
  $(document).ready(function() {
    var arr = <%= a %>;
    // console.log(arr);
    $.each(arr, function (index, value) {
      $(".header" + value).click(function () {
          $header = $(this);
          //getting the next element
          $content = $("#description" + value);

          //open up the content needed - toggle the slide- if visible, slide up, if not slidedown.
          $content.slideToggle(500, function () {
              //execute this after slideToggle is done
              //change text of header based on visibility of content div
              $header.text(function () {
                  //change text based on condition
                  return $content.is(":visible") ? "Collapse" : "More Detail";
              });
          });

      });
    });
  });
</script>
<div id="map-overlay">
  <div class="map-container">
    <div class="map-close text-right"><a onclick="off()"><%= fa_icon "window-close" %></a></div>
    <div id='index-map'>
    </div>
  </div>
</div>
<script>
  $( ".map-button" ).click(function() {
    $( "#map-overlay" ).fadeIn( "slow", function() {
      map.resize();
      // Animation complete
    });
  });

  // function on() {
  //     document.getElementById("map-overlay").style.display = "block";
  // }
  function off() {
      document.getElementById("map-overlay").style.display = "none";
  }
  var token = "<%= ENV["MAPBOX"] %>";
  mapboxgl.accessToken = token;
  // Set max bounds of map to the whole of UK
  var bounds = [
      [-11.023648, 48.675969], // Southwest coordinates
      [2.599399, 61.280440]  // Northeast coordinates
  ];

  var map = new mapboxgl.Map({
    container: 'index-map',
    style: 'mapbox://styles/mapbox/streets-v10',
    center: [-3.440854, 57.260641], // starting position
    zoom: 9, // starting zoom
    maxBounds: bounds // Sets bounds as max
  });

  // Add zoom and rotation controls to the map.
  map.addControl(new mapboxgl.NavigationControl());

  var indexGeojson = {
    "type": 'FeatureCollection',
    "features": []
  };

  // helper function to create geoJson "feature"
  const createGeoJsonFeature = (longitude, latitude, title, photo, sleeps, bedrooms, bathrooms, url) => {
    return {
      "type": 'Feature',
      "geometry": {
        "type": 'Point',
        "coordinates": [longitude, latitude]
      },
      "properties": {
        "title": title,
        "photo": photo,
        "sleeps": sleeps,
        "bedrooms": bedrooms,
        "bathrooms": bathrooms,
        "url": url
      }
    }
  };

  // helper function to add feature to indexGeoJson
  const addToGeoJson = (geoJsonFeature) => {
    indexGeojson.features.push(geoJsonFeature)
  };

  // add the data to the indexGeojson
  let longitude = 1.0;
  let latitude = 1.0;
  let title = "";
  let photo = "";
  let sleeps = 1.0;
  let bedrooms = 1.0;
  let bathrooms = 1.0;
  let url = "";

  <% @properties.each do |property| %>
    longitude = <%= property.longitude %>
    latitude = <%= property.latitude %>
    title = "<%= property.name %>"
    <% if property.hero_image.blank? %>
      photo = "<%= image_path("cedar-lodge.jpg") %>"
    <% else %>
      photo = "<%= cl_image_path(property.hero_image) %>"
    <% end %>
    sleeps = <%= property.sleeps %>
    bedrooms = <%= property.bedrooms %>
    bathrooms = <%= property.bathrooms %>
    url = "properties/" + <%= "#{property.id}" %>
    console.log(url)
    console.log(longitude)
    console.log(latitude)
    addToGeoJson(createGeoJsonFeature(longitude, latitude, title, photo, sleeps, bedrooms, bathrooms, url));
  <% end %>

  map.on('load', function(e) {
    map.addSource('properties', {
      type: 'geojson',
      data: indexGeojson
    });
  });

  function flyToProperty(currentFeature) {
    map.flyTo({
      center: [(currentFeature.geometry.coordinates[0]), currentFeature.geometry.coordinates[1] - 0.015],
      zoom: 12,
      speed: 0.5
    });
  }

  function createPopUp(currentFeature) {
    var popUps = document.getElementsByClassName('mapboxgl-popup');
    // Check if there is already a popup on the map and if so, remove it
    if (popUps[0]) popUps[0].remove();

    var popup = new mapboxgl.Popup({ offset: 25 })
      .setLngLat(currentFeature.geometry.coordinates)
      .setHTML('<h5>' + currentFeature.properties.title + '</h5>' + '<img src=' + currentFeature.properties.photo + ' height="150" width="200">' + '<p><strong>Sleeps:</strong>' + currentFeature.properties.sleeps + '</p><p><strong>Bedrooms:</strong>' + currentFeature.properties.bedrooms + '</p><p><strong>Bathrooms:</strong> ' + currentFeature.properties.bathrooms + '</p><a href=' + currentFeature.properties.url + '>' + '<h6 class="map-btn">View Lodge</h6></a>')
      .addTo(map);
  }

  // this is so it is possible to use .remove() function in older browsers
  if (!('remove' in Element.prototype)) {
    Element.prototype.remove = function() {
      if (this.parentNode) {
        this.parentNode.removeChild(this);
      }
    };
  }

  const pointLinks = document.querySelectorAll('.point-link');
  pointLinks.forEach((element) => {
    // Add an event listener for the links in the sidebar listing
    element.addEventListener('click', function(e) {
      // Update the currentFeature to the store associated with the clicked link
      var clickedListing = indexGeojson.features[this.dataset.position];
      // 1. Fly to the point associated with the clicked link
      flyToProperty(clickedListing);
      // 2. Close all other popups and display popup for clicked property
      createPopUp(clickedListing);
    });
  })

  // Add markers to map
  indexGeojson.features.forEach(function(marker) {
    // create a HTML element for each feature
    var el = document.createElement('i');
    el.className = 'marker';
    // make a marker for each poi feature and add to the map
    new mapboxgl.Marker(el)
    .setLngLat(marker.geometry.coordinates)
    .setPopup(new mapboxgl.Popup({ offset: 25 })
    .setHTML('<h5>' + marker.properties.title + '</h5>' + '<img src=' + marker.properties.photo + ' height="150" width="200">' + '<p><strong>Sleeps:</strong> ' + marker.properties.sleeps + '</p><p><strong>Bedrooms:</strong> ' + marker.properties.bedrooms + '</p><p><strong>Bathrooms:</strong> ' + marker.properties.bathrooms + '</p><a href=' + marker.properties.url + '>' + '<h6 class="map-btn">View Lodge</h6></a>'))
    .addTo(map);
    // console.log(marker.geometry.coordinates[0] - )

    el.addEventListener('click', (e) => {
      flyToProperty(marker);
      createPopUp(marker);
      e.stopPropagation();
      // if (activeItem[0]) {
      //   activeItem[0].classList.remove('active');
      // }
      // var listing = document.getElementById('listing-' + i);
      // console.log(listing);
      // listing.classList.add('active');
    })
  });

</script>
